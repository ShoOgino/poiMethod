   @Override
   public ByteBuffer read(int length, long position) throws IOException {
      if(position >= size()) {
         throw new IndexOutOfBoundsException("Position " + position + " past the end of the file");
      }
      
      // Do we read or map (for read/write)?
      ByteBuffer dst;
      if (writable) {
          dst = channel.map(FileChannel.MapMode.READ_WRITE, position, length);

          // remember this buffer for cleanup
          buffersToClean.add(dst);
      } else {
          // allocate the buffer on the heap if we cannot map the data in directly
          channel.position(position);
          dst = ByteBuffer.allocate(length);

          // Read the contents and check that we could read some data
          int worked = IOUtils.readFully(channel, dst);
          if(worked == -1) {
              throw new IndexOutOfBoundsException("Position " + position + " past the end of the file");
          }
      }

      // make it ready for reading
      dst.position(0);

      // All done
      return dst;
   }

