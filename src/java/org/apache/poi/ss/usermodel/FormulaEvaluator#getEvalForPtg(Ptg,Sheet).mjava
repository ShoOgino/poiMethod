    /**
     * returns an appropriate Eval impl instance for the Ptg. The Ptg must be
     * one of: Area3DPtg, AreaPtg, ReferencePtg, Ref3DPtg, IntPtg, NumberPtg,
     * StringPtg, BoolPtg <br/>special Note: OperationPtg subtypes cannot be
     * passed here!
     */
    private Eval getEvalForPtg(Ptg ptg, Sheet sheet) {
        if (ptg instanceof NamePtg) {
            // named ranges, macro functions
            NamePtg namePtg = (NamePtg) ptg;
            int numberOfNames = _workbook.getNumberOfNames();
            int nameIndex = namePtg.getIndex();
            if(nameIndex < 0 || nameIndex >= numberOfNames) {
                throw new RuntimeException("Bad name index (" + nameIndex
                        + "). Allowed range is (0.." + (numberOfNames-1) + ")");
            }
            if(_workbook instanceof org.apache.poi.hssf.usermodel.HSSFWorkbook) { 
				org.apache.poi.hssf.usermodel.HSSFWorkbook hssfWb = 
					(org.apache.poi.hssf.usermodel.HSSFWorkbook)_workbook;
				NameRecord nameRecord = hssfWb.getNameRecord(nameIndex);
				if (nameRecord.isFunctionName()) {
					return new NameEval(nameRecord.getNameText());
				}
				if (nameRecord.hasFormula()) {
					return evaluateNameFormula(nameRecord.getNameDefinition(), sheet);
				}
				throw new RuntimeException("Don't know how to evalate name '" + nameRecord.getNameText() + "'");
			} else {
				throw new RuntimeException("Don't know how to evaluate name records for XSSF");
			}
        }
        if (ptg instanceof NameXPtg) {
            NameXPtg nameXPtg = (NameXPtg) ptg;
            return new NameXEval(nameXPtg.getSheetRefIndex(), nameXPtg.getNameIndex());
        }
        if (ptg instanceof RefPtg) {
            return new LazyRefEval(((RefPtg) ptg), sheet, this);
        }
        if (ptg instanceof Ref3DPtg) {
            Ref3DPtg refPtg = (Ref3DPtg) ptg;
            Sheet xsheet = getOtherSheet(refPtg.getExternSheetIndex());
            return new LazyRefEval(refPtg, xsheet, createEvaluatorForAnotherSheet(xsheet));
        }
        if (ptg instanceof AreaPtg) {
            return new LazyAreaEval(((AreaPtg) ptg), sheet, this);
        }
        if (ptg instanceof Area3DPtg) {
            Area3DPtg a3dp = (Area3DPtg) ptg;
            Sheet xsheet = getOtherSheet(a3dp.getExternSheetIndex());
            return new LazyAreaEval(a3dp, xsheet, createEvaluatorForAnotherSheet(xsheet));
        }

        if (ptg instanceof IntPtg) {
            return new NumberEval(((IntPtg)ptg).getValue());
        }
        if (ptg instanceof NumberPtg) {
            return new NumberEval(((NumberPtg)ptg).getValue());
        }
        if (ptg instanceof StringPtg) {
            return new StringEval(((StringPtg) ptg).getValue());
        }
        if (ptg instanceof BoolPtg) {
            return BoolEval.valueOf(((BoolPtg) ptg).getValue());
        }
        if (ptg instanceof ErrPtg) {
            return ErrorEval.valueOf(((ErrPtg) ptg).getErrorCode());
        }
        if (ptg instanceof UnknownPtg) {
            // TODO - remove UnknownPtg
            throw new RuntimeException("UnknownPtg not allowed");
        }
        throw new RuntimeException("Unexpected ptg class (" + ptg.getClass().getName() + ")");
    }

