    /**
     * returns an appropriate Eval impl instance for the Ptg. The Ptg must be
     * one of: Area3DPtg, AreaPtg, ReferencePtg, Ref3DPtg, IntPtg, NumberPtg,
     * StringPtg, BoolPtg <br/>special Note: OperationPtg subtypes cannot be
     * passed here!
     */
    private static Eval getEvalForPtg(Ptg ptg, HSSFSheet sheet, HSSFWorkbook workbook) {
        if (ptg instanceof NamePtg) {
            // named ranges, macro functions
            NamePtg namePtg = (NamePtg) ptg;
            int numberOfNames = workbook.getNumberOfNames();
            int nameIndex = namePtg.getIndex();
            if(nameIndex < 0 || nameIndex >= numberOfNames) {
                throw new RuntimeException("Bad name index (" + nameIndex 
                        + "). Allowed range is (0.." + (numberOfNames-1) + ")");
            }
            NameRecord nameRecord = workbook.getWorkbook().getNameRecord(nameIndex);
            if (nameRecord.isFunctionName()) {
                return new NameEval(nameRecord.getNameText());
            }
            if (nameRecord.hasFormula()) {
                return evaluateNameFormula(nameRecord.getNameDefinition(), sheet, workbook);
            }
            
            throw new RuntimeException("Don't now how to evalate name '" + nameRecord.getNameText() + "'");
        }
        if (ptg instanceof NameXPtg) {
            NameXPtg nameXPtg = (NameXPtg) ptg;
            return new NameXEval(nameXPtg.getSheetRefIndex(), nameXPtg.getNameIndex());
        }
        if (ptg instanceof RefPtg) {
            return new LazyRefEval(((RefPtg) ptg), sheet, workbook);
        }
        if (ptg instanceof Ref3DPtg) {
            Ref3DPtg refPtg = (Ref3DPtg) ptg;
            Workbook wb = workbook.getWorkbook();
            HSSFSheet xsheet = workbook.getSheetAt(wb.getSheetIndexFromExternSheetIndex(refPtg.getExternSheetIndex()));
            return new LazyRefEval(refPtg, xsheet, workbook);
        }
        if (ptg instanceof AreaPtg) {
            return new LazyAreaEval(((AreaPtg) ptg), sheet, workbook);
        }
        if (ptg instanceof Area3DPtg) {
            Area3DPtg a3dp = (Area3DPtg) ptg;
            Workbook wb = workbook.getWorkbook();
            HSSFSheet xsheet = workbook.getSheetAt(wb.getSheetIndexFromExternSheetIndex(a3dp.getExternSheetIndex()));
            return new LazyAreaEval(a3dp, xsheet, workbook);
        }

        if (ptg instanceof IntPtg) {
            return new NumberEval(((IntPtg)ptg).getValue());
        }
        if (ptg instanceof NumberPtg) {
            return new NumberEval(((NumberPtg)ptg).getValue());
        }
        if (ptg instanceof StringPtg) {
            return new StringEval(((StringPtg) ptg).getValue());
        }
        if (ptg instanceof BoolPtg) {
            return BoolEval.valueOf(((BoolPtg) ptg).getValue());
        }
        if (ptg instanceof ErrPtg) {
            return ErrorEval.valueOf(((ErrPtg) ptg).getErrorCode());
        }
        if (ptg instanceof UnknownPtg) { 
            // TODO - remove UnknownPtg
            throw new RuntimeException("UnknownPtg not allowed");
        }
        throw new RuntimeException("Unexpected ptg class (" + ptg.getClass().getName() + ")");
    }

