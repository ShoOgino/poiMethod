    /**
     * read support  (offset used as starting point for search) for low level
     * API.  Pass in an array of Record objects, the sheet number (0 based) and
     * a record offset (should be the location of the sheets BOF record).  A Sheet
     * object is constructed and passed back with all of its initialization set
     * to the passed in records and references to those records held. This function
     * is normally called via Workbook.
     *
     * @param recs array containing those records in the sheet in sequence (normally obtained from RecordFactory)
     * @param sheetnum integer specifying the sheet's number (0,1 or 2 in this release)
     * @param offset of the sheet's BOF record
     *
     * @return Sheet object with all values set to those read from the file
     *
     * @see org.apache.poi.hssf.model.Workbook
     * @see org.apache.poi.hssf.record.Record
     */
    public static Sheet createSheet(List recs, int sheetnum, int offset)
    {
        if (log.check( POILogger.DEBUG ))
            log.logFormatted(POILogger.DEBUG,
                    "Sheet createSheet (existing file) with %",
                    new Integer(recs.size()));
        Sheet     retval             = new Sheet();
        ArrayList records            = new ArrayList(recs.size() / 5);
        boolean   isfirstcell        = true;
        int       bofEofNestingLevel = 0;

        for (int k = offset; k < recs.size(); k++) {
            Record rec = ( Record ) recs.get(k);
            if ( rec.getSid() == DBCellRecord.sid ) {
                continue;
            }
            if ( rec.getSid() == IndexRecord.sid ) {
                // ignore INDEX record because it is only needed by Excel, 
                // and POI always re-calculates its contents 
                continue;
            }
            if ( rec.getSid() == StringRecord.sid ) {
                continue;
            }
            
            if ( rec.getSid() == CFHeaderRecord.sid ) {
                RecordStream rs = new RecordStream(recs, k);
                retval.condFormatting = new ConditionalFormattingTable(rs);
                k += rs.getCountRead()-1;
                records.add(retval.condFormatting);
                continue;
            }
            
            if (rec.getSid() == ColumnInfoRecord.sid) {
                RecordStream rs = new RecordStream(recs, k);
                retval._columnInfos = new ColumnInfoRecordsAggregate(rs);
                k += rs.getCountRead()-1;
                records.add(retval._columnInfos);
                continue;
            }
            if ( rec.getSid() == DVALRecord.sid) {
                RecordStream rs = new RecordStream(recs, k);
                retval._dataValidityTable = new DataValidityTable(rs);
                k += rs.getCountRead() - 1; // TODO - convert this method result to be zero based
                records.add(retval._dataValidityTable);
                continue;
            }
            // TODO construct RowRecordsAggregate from RecordStream
            if ( rec.getSid() == RowRecord.sid ) {
                RowRecord row = (RowRecord)rec;
                if (retval._rowsAggregate == null) {
                    retval._rowsAggregate = new RowRecordsAggregate();
                    records.add(retval._rowsAggregate); //only add the aggregate once
                }
                retval._rowsAggregate.insertRow(row);
                continue;
            }
            if ( rec.isValue() && bofEofNestingLevel == 1 ) {
                if (isfirstcell) {
                    isfirstcell = false;
                    if (retval._rowsAggregate == null) {
                        retval._rowsAggregate = new RowRecordsAggregate();
                        records.add(retval._rowsAggregate); //only add the aggregate once
                    }
                    retval._rowsAggregate.constructCellValues( k, recs );
                }
               continue;
            }
                       
            
            if (rec.getSid() == MergeCellsRecord.sid) {
                RecordStream rs = new RecordStream(recs, k);
                retval._mergedCellsTable = new MergedCellsTable(rs);
                records.add(retval._mergedCellsTable);
                continue; // TODO
            }
            
            if (rec.getSid() == BOFRecord.sid)
            {
                bofEofNestingLevel++;
                if (log.check( POILogger.DEBUG ))
                    log.log(POILogger.DEBUG, "Hit BOF record. Nesting increased to " + bofEofNestingLevel);
            }
            else if (rec.getSid() == EOFRecord.sid)
            {
                --bofEofNestingLevel;
                if (log.check( POILogger.DEBUG ))
                    log.log(POILogger.DEBUG, "Hit EOF record. Nesting decreased to " + bofEofNestingLevel);
                if (bofEofNestingLevel == 0) {
                    records.add(rec);
                    retval.eofLoc = k;
                    break;
                }
            }
            else if (rec.getSid() == UncalcedRecord.sid) {
                retval._isUncalced = true;
            }
            else if (rec.getSid() == DimensionsRecord.sid)
            {
                // Make a columns aggregate if one hasn't ready been created.
                if (retval._columnInfos == null)
                {
                    retval._columnInfos = new ColumnInfoRecordsAggregate();
                    records.add(retval._columnInfos);
                }

                retval.dims    = ( DimensionsRecord ) rec;
                retval.dimsloc = records.size();
            }
            else if (rec.getSid() == DefaultColWidthRecord.sid)
            {
                retval.defaultcolwidth = ( DefaultColWidthRecord ) rec;
            }
            else if (rec.getSid() == DefaultRowHeightRecord.sid)
            {
                retval.defaultrowheight = ( DefaultRowHeightRecord ) rec;
            }
            else if ( rec.getSid() == PrintGridlinesRecord.sid )
            {
                retval.printGridlines = (PrintGridlinesRecord) rec;
            }
            else if ( rec.getSid() == GridsetRecord.sid )
            {
                retval.gridset = (GridsetRecord) rec;
            }
            else if ( rec.getSid() == HeaderRecord.sid && bofEofNestingLevel == 1)
            {
                retval.header = (HeaderRecord) rec;
            }
            else if ( rec.getSid() == FooterRecord.sid && bofEofNestingLevel == 1)
            {
                retval.footer = (FooterRecord) rec;
            }
            else if ( rec.getSid() == PrintSetupRecord.sid && bofEofNestingLevel == 1)
            {
                retval.printSetup = (PrintSetupRecord) rec;
            }
            else if ( rec.getSid() == LeftMarginRecord.sid)
            {
                retval.getMargins()[LeftMargin] = (LeftMarginRecord) rec;
            }
            else if ( rec.getSid() == RightMarginRecord.sid)
            {
                retval.getMargins()[RightMargin] = (RightMarginRecord) rec;
            }
            else if ( rec.getSid() == TopMarginRecord.sid)
            {
                retval.getMargins()[TopMargin] = (TopMarginRecord) rec;
            }
            else if ( rec.getSid() == BottomMarginRecord.sid)
            {
                retval.getMargins()[BottomMargin] = (BottomMarginRecord) rec;
            }
            else if ( rec.getSid() == SelectionRecord.sid )
            {
                retval.selection = (SelectionRecord) rec;
            }
            else if ( rec.getSid() == WindowTwoRecord.sid )
            {
                retval.windowTwo = (WindowTwoRecord) rec;
            }
            else if ( rec.getSid() == ProtectRecord.sid )
            {
                retval.protect = (ProtectRecord) rec;
            }
            else if ( rec.getSid() == ObjectProtectRecord.sid )
            {
                retval.objprotect = (ObjectProtectRecord) rec;
            }
            else if ( rec.getSid() == ScenarioProtectRecord.sid )
            {
                retval.scenprotect = (ScenarioProtectRecord) rec;
            }
            else if ( rec.getSid() == PasswordRecord.sid )
            {
                retval.password = (PasswordRecord) rec;
            }
            else if (rec.getSid() == HorizontalPageBreakRecord.sid)
            {
                retval._rowBreaksRecord = (HorizontalPageBreakRecord)rec;
            }
            else if (rec.getSid() == VerticalPageBreakRecord.sid)
            {
                retval._columnBreaksRecord = (VerticalPageBreakRecord)rec;
            }

            records.add(rec);
        }
        if (retval.dimsloc < 0) {
            throw new RuntimeException("DimensionsRecord was not found");
        }
        retval.records = records;
        retval.checkRows();
        if (log.check( POILogger.DEBUG ))
            log.log(POILogger.DEBUG, "sheet createSheet (existing file) exited");
        return retval;
    }

