    protected Shape fitShapeToView(Shape shape) {
        int scaleUnits = prop.getMapMode().scale;
        Rectangle2D view = prop.getViewport();
        Rectangle2D win = prop.getWindow();
        if (view == null) {
            view = win;
        }
        double scaleX, scaleY;
        switch (scaleUnits) {
        case -1:
            scaleX = view.getWidth() / win.getWidth();
            scaleY = view.getHeight() / win.getHeight();
            break;
        case 0:
            scaleX = scaleY = 1;
            break;
        default:
            scaleX = scaleY = scaleUnits / (double)Units.POINT_DPI;
        }

        AffineTransform at = new AffineTransform();
        at.scale(scaleX, scaleY);
//        at.translate(-view.getX(), -view.getY());
        at.translate(bbox.getWidth()/win.getWidth(), bbox.getHeight()/win.getHeight());

        Shape tshape = at.createTransformedShape(shape);
        return tshape;
    }

