    private byte[] readToByteArray(LittleEndianInputStream leis, long dataSize, long recordSize) throws IOException {

        if (recordSize == 0) {
            return new byte[0];
        }

        byte[] arr = IOUtils.safelyAllocate(dataSize, MAX_RECORD_LENGTH);

        long read = IOUtils.readFully(leis, arr);
        if (read != dataSize) {
            throw new RecordFormatException("InputStream ended before full record could be read");
        }
        long toSkip = recordSize-dataSize;
        long skipped = IOUtils.skipFully(leis, recordSize-dataSize);
        if (toSkip != skipped) {
            throw new RecordFormatException("InputStream ended before full record could be read");
        }
        return arr;
    }

