	public int getCharIndex(int bytePos) {
		int charCount = 0;

        for(TextPiece tp : _textPieces) {
			int pieceStart = tp.getPieceDescriptor().getFilePosition();
			if (pieceStart >= bytePos) {
				break;
			}

			int bytesLength = tp.bytesLength();
			int pieceEnd = pieceStart + bytesLength;

			int toAdd = bytePos > pieceEnd ? bytesLength : bytesLength - (pieceEnd - bytePos);

			if (tp.isUnicode()) {
				charCount += toAdd / 2;
			} else {
				charCount += toAdd;
			}
		}

		return charCount;
	}

