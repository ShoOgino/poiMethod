    protected void runFormatTests(String workbookName, CellValue valueGetter) throws IOException {

        openWorkbook(workbookName);

        readFlags(workbook);

        Set<String> runCategories = new TreeSet<>(
                String.CASE_INSENSITIVE_ORDER);
        String runCategoryList = flagString("Categories", "");
        if (runCategoryList != null) {
            runCategories.addAll(Arrays.asList(runCategoryList.split(
                    "\\s*,\\s*")));
            runCategories.remove(""); // this can be found and means nothing
        }

        Sheet sheet = workbook.getSheet("Tests");
        Iterator<Row> rowIter = sheet.rowIterator();
        // Skip the header row
        rowIter.next();
        while (rowIter.hasNext()) {
            Row row = rowIter.next();
            if (row == null) continue;
            String expectedText     = row.getCell(0).getStringCellValue();
            String format           = row.getCell(1).getStringCellValue();
            Cell value              = row.getCell(2);
            String testCategoryList = row.getCell(3).getStringCellValue();
            boolean byCategory = runByCategory(runCategories, testCategoryList);
            if ((expectedText.length() > 0 || format.length() > 0) && byCategory) {
                tryFormat(row.getRowNum(), expectedText, format, valueGetter, value);
            }
        }

        workbook.close();
    }

