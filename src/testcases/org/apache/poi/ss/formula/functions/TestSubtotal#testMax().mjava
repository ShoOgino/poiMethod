    public void testMax(){

        Workbook wb = new HSSFWorkbook();

        FormulaEvaluator fe = wb.getCreationHelper().createFormulaEvaluator();

        Sheet sh = wb.createSheet();
        Cell a1 = sh.createRow(0).createCell(0);
        a1.setCellValue(1);
        Cell a2 = sh.createRow(1).createCell(0);
        a2.setCellValue(3);
        Cell a3 = sh.createRow(2).createCell(0);
        a3.setCellFormula("SUBTOTAL(4,A1:A2)");
        Cell a4 = sh.createRow(3).createCell(0);
        a4.setCellValue(1);
        Cell a5 = sh.createRow(4).createCell(0);
        a5.setCellValue(7);
        Cell a6 = sh.createRow(5).createCell(0);
        a6.setCellFormula("SUBTOTAL(4,A1:A5)*2 + 2");
        Cell a7 = sh.createRow(6).createCell(0);
        a7.setCellFormula("SUBTOTAL(4,A1:A6)");

        fe.evaluateAll();

        assertEquals(3.0, a3.getNumericCellValue());
        assertEquals(16.0, a6.getNumericCellValue());
        assertEquals(7.0, a7.getNumericCellValue());
    }

