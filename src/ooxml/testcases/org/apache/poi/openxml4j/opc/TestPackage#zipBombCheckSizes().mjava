    @Test
    public void zipBombCheckSizes() throws Exception {
        File file = OpenXML4JTestDataSamples.getSampleFile("sample.xlsx");

        try {
            double min_ratio = Double.MAX_VALUE;
            long max_size = 0;
            ZipFile zf = ZipHelper.openZipFile(file);
            Enumeration<? extends ZipEntry> entries = zf.entries();
            while (entries.hasMoreElements()) {
                ZipEntry ze = entries.nextElement();
                double ratio = (double)ze.getCompressedSize() / (double)ze.getSize();
                min_ratio = Math.min(min_ratio, ratio);
                max_size = Math.max(max_size, ze.getSize());
            }
            zf.close();
    
            // use values close to, but within the limits 
            ZipSecureFile.setMinInflateRatio(min_ratio-0.002);
            ZipSecureFile.setMaxEntrySize(max_size+1);
            Workbook wb = WorkbookFactory.create(file);
            wb.close();
    
            // check ratio ouf of bounds
            ZipSecureFile.setMinInflateRatio(min_ratio+0.002);
            try {
                wb = WorkbookFactory.create(file);
                wb.close();
                // this is a bit strange, as there will be different exceptions thrown
                // depending if this executed via "ant test" or within eclipse
                // maybe a difference in JDK ...
            } catch (InvalidFormatException e) {
                assertEquals("Zip bomb detected! Exiting.", e.getMessage());
            } catch (POIXMLException e) {
                InvocationTargetException t = (InvocationTargetException)e.getCause();
                IOException t2 = (IOException)t.getTargetException();
                assertEquals("Zip bomb detected! Exiting.", t2.getMessage());
            }
    
            // check max entry size ouf of bounds
            ZipSecureFile.setMinInflateRatio(min_ratio-0.002);
            ZipSecureFile.setMaxEntrySize(max_size-1);
            try {
                wb = WorkbookFactory.create(file, null, true);
                wb.close();
            } catch (InvalidFormatException e) {
                assertEquals("Zip bomb detected! Exiting.", e.getMessage());
            } catch (POIXMLException e) {
                InvocationTargetException t = (InvocationTargetException)e.getCause();
                IOException t2 = (IOException)t.getTargetException();
                assertEquals("Zip bomb detected! Exiting.", t2.getMessage());
            }
        } finally {
            // reset otherwise a lot of ooxml tests will fail
            ZipSecureFile.setMinInflateRatio(0.01d);
            ZipSecureFile.setMaxEntrySize(0xFFFFFFFFl);            
        }
    }

