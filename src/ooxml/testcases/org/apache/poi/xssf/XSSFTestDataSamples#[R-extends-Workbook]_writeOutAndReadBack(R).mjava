    public static <R extends Workbook> R writeOutAndReadBack(R wb) {
    	ByteArrayOutputStream baos = new ByteArrayOutputStream(8192);
    	Workbook result;
		try {
	    	wb.write(baos);
	    	InputStream is = new ByteArrayInputStream(baos.toByteArray());
	    	if (wb instanceof HSSFWorkbook) {
	    		result = new HSSFWorkbook(is);
	    	} else if (wb instanceof XSSFWorkbook) {
    			Package pkg = Package.open(is);
    			result = new XSSFWorkbook(pkg);
	    	} else {
	    		throw new RuntimeException("Unexpected workbook type (" 
	    				+ wb.getClass().getName() + ")");
	    	}
		} catch (InvalidFormatException e) {
			throw new RuntimeException(e);
		} catch (IOException e) {
			throw new RuntimeException(e);
		}
		@SuppressWarnings("unchecked")
		R r = (R) result;
		return r;
    }

