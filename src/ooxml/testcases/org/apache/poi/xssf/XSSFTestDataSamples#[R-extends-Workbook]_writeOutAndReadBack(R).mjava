    public static <R extends Workbook> R writeOutAndReadBack(R wb) {
    	Workbook result;
		try {
	    	if (wb instanceof HSSFWorkbook) {
                ByteArrayOutputStream baos = new ByteArrayOutputStream(8192);
                wb.write(baos);
                InputStream is = new ByteArrayInputStream(baos.toByteArray());
	    		result = new HSSFWorkbook(is);
	    	} else if (wb instanceof XSSFWorkbook) {
                File tmp = File.createTempFile("poi-ooxml-", ".xlsx");
                tmp.deleteOnExit();
                FileOutputStream out = new FileOutputStream(tmp);
                wb.write(out);
                out.close();
    			Package pkg = Package.open(tmp.getAbsolutePath());
    			result = new XSSFWorkbook(pkg);
	    	} else {
	    		throw new RuntimeException("Unexpected workbook type (" 
	    				+ wb.getClass().getName() + ")");
	    	}
		} catch (InvalidFormatException e) {
			throw new RuntimeException(e);
		} catch (IOException e) {
			throw new RuntimeException(e);
		}
		@SuppressWarnings("unchecked")
		R r = (R) result;
		return r;
    }

