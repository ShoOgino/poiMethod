    @Override
    public void postSign(Document document, List<X509Certificate> signingCertificateChain) 
    throws MarshalException {
        LOG.log(POILogger.DEBUG, "postSign");

        NodeList nl = document.getElementsByTagNameNS(XmlDSigNS, "Object");
        
        /*
         * Make sure we insert right after the ds:SignatureValue element, just
         * before the first ds:Object element.
         */
        Node nextSibling = (nl.getLength() == 0) ? null : nl.item(0);

        /*
         * Construct the ds:KeyInfo element using JSR 105.
         */
        KeyInfoFactory keyInfoFactory = SignatureInfo.getKeyInfoFactory();
        List<Object> x509DataObjects = new ArrayList<Object>();
        X509Certificate signingCertificate = signingCertificateChain.get(0);

        List<Object> keyInfoContent = new ArrayList<Object>();

        if (this.includeKeyValue) {
            KeyValue keyValue;
            try {
                keyValue = keyInfoFactory.newKeyValue(signingCertificate.getPublicKey());
            } catch (KeyException e) {
                throw new RuntimeException("key exception: " + e.getMessage(), e);
            }
            keyInfoContent.add(keyValue);
        }

        if (this.includeIssuerSerial) {
            x509DataObjects.add(keyInfoFactory.newX509IssuerSerial(
                    signingCertificate.getIssuerX500Principal().toString(),
                    signingCertificate.getSerialNumber()));
        }

        if (this.includeEntireCertificateChain) {
            x509DataObjects.addAll(signingCertificateChain);
        } else {
            x509DataObjects.add(signingCertificate);
        }

        if (!x509DataObjects.isEmpty()) {
            X509Data x509Data = keyInfoFactory.newX509Data(x509DataObjects);
            keyInfoContent.add(x509Data);
        }
        KeyInfo keyInfo = keyInfoFactory.newKeyInfo(keyInfoContent);
        DOMKeyInfo domKeyInfo = (DOMKeyInfo)keyInfo; 

        Key key = new Key() {
            private static final long serialVersionUID = 1L;

            public String getAlgorithm() {
                return null;
            }

            public byte[] getEncoded() {
                return null;
            }

            public String getFormat() {
                return null;
            }
        };

        Element n = document.getDocumentElement();
        DOMSignContext domSignContext = new DOMSignContext(key, n, nextSibling);
        DOMCryptoContext domCryptoContext = domSignContext;
        domCryptoContext.putNamespacePrefix(XmlDSigNS, "xd");
        DOMStructure domStructure = new DOMStructure(n);
        // how to set nextSibling??? - marshal is ignoring nextSibling in DOMSignContext
        domKeyInfo.marshal(domStructure, domCryptoContext);
        
        // move keyinfo into the right place
        if (nextSibling != null) {
            NodeList kiNl = document.getElementsByTagNameNS(XmlDSigNS, "KeyInfo");
            if (kiNl.getLength() != 1) {
                throw new RuntimeException("KeyInfo wasn't set");
            }
            nextSibling.getParentNode().insertBefore(kiNl.item(0), nextSibling);
        }
    }

