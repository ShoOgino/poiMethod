    /**
     * Creates a Workbook from the given NPOIFSFileSystem, which may
     *  be password protected
     */
    private static Workbook create(NPOIFSFileSystem fs, String password) throws IOException, InvalidFormatException {
        DirectoryNode root = fs.getRoot();
        if (root.hasEntry(Decryptor.DEFAULT_POIFS_ENTRY)) {
            if (password == null) {
                throw new EncryptedDocumentException("The supplied spreadsheet is protected, but no password was supplied");
            } else {
                EncryptionInfo info = new EncryptionInfo(fs);
                Decryptor d = Decryptor.getInstance(info);
                
                boolean passwordCorrect = false;
                InputStream stream = null;
                try {
                    if (d.verifyPassword(password)) {
                        passwordCorrect = true;
                        stream = d.getDataStream(root);
                    }
                } catch (GeneralSecurityException e) {}
                
                if (! passwordCorrect) 
                    throw new EncryptedDocumentException("Password incorrect");
                
                OPCPackage pkg = OPCPackage.open(stream);
                return create(pkg);
            }
        }
        
        if (password != null) {
            Biff8EncryptionKey.setCurrentUserPassword(password);
        }
        Workbook wb = new HSSFWorkbook(root, true);
        Biff8EncryptionKey.setCurrentUserPassword(null);
        return wb;
    }

