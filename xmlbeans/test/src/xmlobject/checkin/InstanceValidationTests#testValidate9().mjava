        public void testValidate9() throws Exception
        {

            String[] schemas = {
                "<xs:schema xmlns:xs='http://www.w3.org/2001/XMLSchema'>" +
                "   <xs:element name='order' type='OrderType'>" +
                "       <xs:keyref name='prodNumKeyRef' refer='prodNumKey'>" +
                "           <xs:selector xpath='items/*'/>" +
                "           <xs:field xpath='@number'/>" +
                "       </xs:keyref>" +
                "       <xs:key name='prodNumKey'>" +
                "           <xs:selector xpath='.//product'/>" +
                "           <xs:field xpath='number'/>" +
                "       </xs:key>" +
                "   </xs:element>" +

                "   <xs:complexType name='OrderType'>" +
                "       <xs:sequence>" +
                "           <xs:element name='items'>" +
                "               <xs:complexType>" +
                "                   <xs:sequence>" +
                "                       <xs:element name='item' type='ItemType' minOccurs='0' maxOccurs='unbounded'/>" +
                "                   </xs:sequence>" +
                "               </xs:complexType>" +
                "           </xs:element>" +
                "           <xs:element name='products'>" +
                "               <xs:complexType>" +
                "                   <xs:sequence>" +
                "                       <xs:element name='product' type='ProductType' maxOccurs='unbounded' minOccurs='0'/>" +
                "                   </xs:sequence>" +
                "               </xs:complexType>" +
                "           </xs:element>" +
                "       </xs:sequence>" +
                "       <xs:attribute name='number' type='xs:string'/>" +
                "   </xs:complexType>" +

                "   <xs:complexType name='ItemType'>" +
                "       <xs:sequence>" +
                "           <xs:element name='quantity' type='xs:int'/>" +
                "       </xs:sequence>" +
                "       <xs:attribute name='number' type='xs:int'/>" +
                "   </xs:complexType>" +

                "   <xs:complexType name='ProductType'>" +
                "       <xs:sequence>" +
                "           <xs:element name='number' type='xs:int' minOccurs='0'/>" +
                "           <xs:element name='name' type='xs:string'/>" +
                "           <xs:element name='price'>" +
                "               <xs:complexType>" +
                "                   <xs:simpleContent>" +
                "                       <xs:extension base='xs:decimal'>" +
                "                           <xs:attribute name='currency' type='xs:string'/>" +
                "                       </xs:extension>" +
                "                   </xs:simpleContent>" +
                "               </xs:complexType>" +
                "           </xs:element>" +
                "       </xs:sequence>" +
                "   </xs:complexType>" +
                "</xs:schema> ",

                "<xsd:schema xmlns:xsd='http://www.w3.org/2001/XMLSchema'>" +

                "    <xsd:element name='root' type='RootType'>" +
                "        <xsd:key name='FooId'>" +
                "            <xsd:selector xpath='.//string|.//token|.//int'/>" +
                "            <xsd:field xpath='@id'/>" +
                "        </xsd:key>" +
                "    </xsd:element>" +

                "    <xsd:group name='group'>" +
                "        <xsd:choice>" +
                "            <xsd:element ref='string'/>" +
                "            <xsd:element ref='token'/>" +
                "            <xsd:element ref='int'/>" +
                "        </xsd:choice>" +
                "    </xsd:group>" +

                "    <xsd:complexType name='RootType'>" +
                "        <xsd:group ref='group' minOccurs='0' maxOccurs='unbounded'/>" +
                "    </xsd:complexType>" +

                "    <xsd:element name='string'>" +
                "       <xsd:complexType>" +
                "            <xsd:group ref='group' minOccurs='0' maxOccurs='unbounded'/>" +
                "            <xsd:attribute name='id' type='xsd:string'/>" +
                "        </xsd:complexType>" +
                "    </xsd:element>" +

                "    <xsd:element name='int'>" +
                "        <xsd:complexType>" +
                "            <xsd:group ref='group' minOccurs='0' maxOccurs='unbounded'/>" +
                "            <xsd:attribute name='id' type='xsd:int'/>" +
                "        </xsd:complexType>" +
                "    </xsd:element>" +

                "    <xsd:element name='token'>" +
                "        <xsd:complexType>" +
                "            <xsd:group ref='group' minOccurs='0' maxOccurs='unbounded'/>" +
                "            <xsd:attribute name='id' type='xsd:token'/>" +
                "        </xsd:complexType>" +
                "    </xsd:element>" +

                "</xsd:schema>",

                "<xsd:schema xmlns:xsd='http://www.w3.org/2001/XMLSchema' " +
                "    targetNamespace='http://www.tim-hanson.com/' xmlns:th='http://www.tim-hanson.com/' " +
                "    attributeFormDefault='qualified' elementFormDefault='qualified'>" +

                "    <xsd:element name='root'>" +
                "        <xsd:complexType>" +
                "            <xsd:sequence>" +
                "                <xsd:element name='foo' maxOccurs='unbounded'>" +
                "                    <xsd:complexType>" +
                "                        <xsd:attribute name='id' type='xsd:int'/>" +
                "                    </xsd:complexType>" +
                "                </xsd:element>" +
                "            </xsd:sequence>" +
                "        </xsd:complexType>" +
                "        <xsd:key name='id'>" +
                "            <xsd:selector xpath='./th:foo'/>" +
                "            <xsd:field xpath='@th:id'/>" +
                "        </xsd:key>" +
                "    </xsd:element>" +
                "</xsd:schema>",

                "<xsd:schema xmlns:xsd='http://www.w3.org/2001/XMLSchema' >" +
                "    <xsd:element name='idtest'>" +
                "        <xsd:complexType>" +
                "            <xsd:sequence maxOccurs='unbounded'>" +
                "                <xsd:choice>" +
                "                    <xsd:element name='id' maxOccurs='unbounded' type='xsd:ID'/>" +
                "                    <xsd:element name='idref' maxOccurs='unbounded' type='xsd:IDREF'/>" +
                "                    <xsd:element name='idrefs' maxOccurs='unbounded' type='xsd:IDREFS'/>" +
                "                </xsd:choice>" +
                "            </xsd:sequence>" +
                "        </xsd:complexType>" +
                "    </xsd:element>" +
                "</xsd:schema>",

            };

            String[] valid = {
                "<order>" +
                "    <items>" +
                "      <item number='124 '>" +
                "          <quantity>1</quantity>" +
                "      </item>" +
                "      <item number=' 563  '>" +
                "          <quantity>1</quantity>" +
                "      </item>" +
                "    </items>" +
                "    <products>" +
                "        <product>" +
                "            <number> 124</number>" +
                "            <name>Shirt</name>" +
                "            <price currency='USD'>29.99</price>" +
                "        </product>" +
                "        <product>" +
                "            <number> 563 </number>" +
                "            <name>Hat</name>" +
                "            <price currency='USD'>69.99</price>" +
                "        </product>" +
                "        <product>" +
                "            <number>443</number>" +
                "            <name>Umbrella</name>" +
                "            <price currency='USD'>49.99</price>" +
                "        </product>" +
                "    </products>" +
                "</order>",

                "<root>" +
                "    <string id='foo1'>" +
                "        <string id='foo2'>" +
                "            <string id='foo3'>" +
                "                <string id='foo6'>" +
                "                    <string id='foo7'>" +
                "                        <string id='foo8'/>" +
                "                    </string>" +
                "                </string>" +
                "            </string>" +
                "            <string id='foo4'/>" +
                "        </string>" +
                "        <string id='foo9'/>" +
                "    </string>" +
                "</root>",

                "<root>" +
                "    <int id='1'/>" +
                "    <string id='1'/>" +
                "</root>",

                "<xyz:root xmlns:xyz='http://www.tim-hanson.com/'>" +
                "  <xyz:foo xyz:id='1'/>" +
                "  <xyz:foo xyz:id='2'/>" +
                "  <xyz:foo xyz:id='3'/>" +
                "</xyz:root>",

                "<idtest>" +
                "  <idref>xyz</idref>" +
                "  <idrefs>abc def</idrefs>" +
                "  <id>abc</id>" +
                "  <id>def</id>" +
                "  <id>xyz</id>" +
                "  <idref>abc</idref>" +
                "  <idrefs>xyz abc</idrefs>" +
                "</idtest>",
            };

            String[] invalid = {
                "<order>" +
                "    <items>" +
                "      <item number='125 '>" +
                "          <quantity>1</quantity>" +
                "      </item>" +
                "      <item number='563'>" +
                "          <quantity>1</quantity>" +
                "      </item>" +
                "    </items>" +
                "    <products>" +
                "        <product>" +
                "            <number> 124</number>" +
                "            <name>Shirt</name>" +
                "            <price currency='USD'>29.99</price>" +
                "        </product>" +
                "        <product>" +
                "            <number>563</number>" +
                "            <name>Hat</name>" +
                "            <price currency='USD'>69.99</price>" +
                "        </product>" +
                "        <product>" +
                "            <number>443</number>" +
                "            <name>Umbrella</name>" +
                "            <price currency='USD'>49.99</price>" +
                "        </product>" +
                "    </products>" +
                "</order>",

                "<root>" +
                "    <token token='  blah  blah'/>" +
                "    <string id='blah blah'/>" +
                "</root>",

                "<root>" +
                "    <string id='foo1'>" +
                "        <string id='foo2'>" +
                "            <string id='foo3'>" +
                "                <string id='foo6'>" +
                "                    <string id='foo7'>" +
                "                        <string id='foo3'/>" +
                "                    </string>" +
                "                </string>" +
                "            </string>" +
                "        </string>" +
                "    </string>" +
                "</root>",

                "<xyz:root xmlns:xyz='http://www.tim-hanson.com/'>" +
                "  <xyz:foo xyz:id='1'/>" +
                "  <xyz:foo xyz:id='2'/>" +
                "  <xyz:foo xyz:id='2'/>" +
                "</xyz:root>",
            };

            String[] invalidOnDocOnly = new String[]
            {

                "<idtest>" +
                "  <idref>foo</idref>" +
                "  <id>abc</id>" +
                "  <id>def</id>" +
                "  <id>xyz</id>" +
                "</idtest>",

                "<idtest>" +
                "  <idrefs>abc foo</idrefs>" +
                "  <id>abc</id>" +
                "  <id>def</id>" +
                "  <id>xyz</id>" +
                "</idtest>",
            };


            doTest(schemas, null, valid, invalid, true);
            doTest(schemas, null, valid, invalid, false);

             // IDRefs are validated only if starting at the very root of the world
            doTest(schemas, null, new String[0], invalidOnDocOnly, true);
            doTest(schemas, null, invalidOnDocOnly, new String[0], false);
        }

