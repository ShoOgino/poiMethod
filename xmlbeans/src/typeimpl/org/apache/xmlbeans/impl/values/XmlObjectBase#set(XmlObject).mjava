    public final XmlObject set(XmlObject src)
    {
        if (isImmutable())
            throw new IllegalStateException("Cannot set the value of an immutable XmlObject");

        XmlObjectBase obj = underlying(src);

        TypeStoreUser newObj = this;

        if (obj == null)
        {
            setNil();
            return this;
        }

        if (obj.isImmutable())
            setStringValue(obj.getStringValue());
        else
        {
            boolean noSyncThis = preCheck();
            boolean noSyncObj  = obj.preCheck();

            if (monitor() == obj.monitor())             // both are in the same locale
            {
                if (noSyncThis)                         // the locale is not sync
                    newObj = setterHelper( obj );
                else                                    // the locale is sync
                {
                    synchronized (monitor()) {
                        newObj = setterHelper( obj );
                    }
                }
            }
            else                                        // on different locale's
            {
                if (noSyncThis)
                {
                    if (noSyncObj)                      // both unsync
                    {
                        newObj = setterHelper( obj );
                    }
                    else                                // only obj is sync
                    {
                        synchronized (obj.monitor()) {
                            newObj = setterHelper( obj );
                        }
                    }
                }
                else
                {
                    if (noSyncObj)                      // only this is sync
                    {
                        synchronized (monitor()) {
                            newObj = setterHelper( obj );
                        }
                    }
                    else                                // both are sync can't avoid the global lock
                    {
                        boolean acquired = false;

                        try
                        {
                            // about to grab two locks: don't deadlock ourselves
                            GlobalLock.acquire();
                            acquired = true;

                            synchronized (monitor())
                            {
                                synchronized (obj.monitor())
                                {
                                    GlobalLock.release();
                                    acquired = false;

                                    newObj = setterHelper( obj );
                                }
                            }
                        }
                        catch (InterruptedException e)
                        {
                            throw new XmlRuntimeException(e);
                        }
                        finally
                        {
                            if (acquired)
                                GlobalLock.release();
                        }
                    }
                }
            }
        }

        return (XmlObject) newObj;
    }

